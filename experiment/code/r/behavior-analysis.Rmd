---
title: "RMANOVA"
author: "Amelia Ritger"
date: "2024-11-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import data
```{r}
source("mergeAllData.R", local = knitr::knit_global())
```


# Create clean df
```{r}
behavior_clean <- all %>%
  mutate(genet_tank = paste(tank, genet, sep = "")) %>%
  dplyr::select(date, tank, genet, genet_tank, treatment, mhw, n_true, percent_fully_open, percent_closed)
```

# Initial plot to visualize trends
```{r}
image <- ggplot(behavior_clean, aes(x = genet, y = percent_fully_open, fill = genet, group = interaction(genet, mhw), shape = mhw)) +
  geom_point(aes(color = genet), position = position_dodge(width = 0.9), alpha = 0.5) +
  geom_violin(aes(size = mhw), position = position_dodge(width = 0.9), alpha = 0.3, color = alpha("black", 0.75)) +
  facet_wrap(~treatment,
             labeller =  labeller(treatment = c("cold" = "Ambient", "severe" = "Severe MHW", "extreme" = "Extreme MHW"))) +
  scale_size_manual(values = c("during" = 1, "after" = 0.5), labels = c("During MHW", "After MHW")) + # Define sizes for mhw levels
  scale_shape_manual(values = c("during" = 16, "after" = 17), labels = c("During MHW", "After MHW")) + # Define shapes for mhw levels
  # change color of violin 
  scale_fill_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  labs(x = "Genet",
       y = "% open polyps",
       color = "Genet",
       shape = "MHW",
       size = "MHW") +
  guides(fill = "none",
         color = "none") +
  theme_bw() +
  theme(text = element_text(size = 20))

#ggsave(file = here("experiment", "figures", "WSN","behavior.svg"), plot = image, width=12, height=7)
```

## Check ANOVA assumptions
```{r}
# Fit your ANOVA model
model <- aov(percent_fully_open ~ mhw * treatment * genet, data = behavior_clean)
model2 <- lmer(percent_fully_open ~ mhw * treatment * genet + (1 | genet_tank), data = behavior_clean)
```


```{r}
# Extract residuals
residuals <- residuals(model)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model))
```

```{r}
# Extract residuals
residuals <- residuals(model2)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model2, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model2))
```

```{r}
# Fit a model with a variance structure (e.g., weights = varIdent for heteroscedasticity)
model_with_var <- lme(percent_fully_open ~ mhw * treatment * genet,
                      random = ~ 1 | genet_tank,
                      weights = varIdent(form = ~ 1 | mhw),  # Adjust variance by timeframe
                      data = behavior_clean)

# Extract residuals
residuals <- residuals(model_with_var)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model_with_var, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model_with_var))
```

```{r}
model3 <- lme(percent_fully_open ~ mhw* treatment + genet,
                   random = ~1|genet_tank,
                   data = behavior_clean,
                   correlation = corAR1(form = ~ 1|genet_tank))

# Extract residuals
residuals <- residuals(model3)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model3, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model3))
```

```{r}
model4 <- lme(percent_fully_open ~ mhw* treatment + genet,
                   random = ~mhw|genet_tank,
                   data = behavior_clean,
                   correlation = corAR1(form = ~ 1|genet_tank))

# Extract residuals
residuals <- residuals(model4)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model4, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model4))
```

```{r}
model_with_time_order <- lmer(percent_fully_open ~ mhw * treatment * genet + (1 | genet_tank), data = behavior_clean)

# Fit a model with interactions between timeframe and treatment/genotype
model_with_interactions <- lmer(percent_fully_open ~ mhw * treatment * genet + (1 | genet_tank), data = behavior_clean)

# Check residuals
qqnorm(residuals(model_with_interactions))
qqline(residuals(model_with_interactions), col = "red")
```

```{r}
behavior_sum <- behavior_clean %>%
  group_by(treatment, mhw, genet) %>%
  summarize(n = n(),
            mean = mean(percent_fully_open),
            sd = sd(percent_fully_open))
```

```{r}
autoArima <- auto.arima(behavior_clean$percent_fully_open, seasonal = TRUE, stepwise = FALSE, approximation = FALSE)
summary(autoArima)

behavior_arma <- lme(percent_fully_open ~ treatment * genet + mhw,
                   random = ~1|genet_tank,
                   data = behavior_clean,
                   correlation = corARMA(p = 4, q = 1))
```


```{r}
summary(behavior_arma)
residuals <- residuals(behavior_arma)
fitted_values <- fitted(behavior_arma)

# Residuals vs Fitted Plot
par(mfrow = c(1, 2)) # Set up the plot layout for two plots side by side

# Plot 1: Residuals vs Fitted
plot(fitted_values, residuals, 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     main = "Residuals vs Fitted",
     pch = 16, col = "gray")
abline(h = 0, col = "red", lty = 2) # Add a horizontal line at 0

# Plot 2: Spread-Level Plot (Scale-Location Plot)
# Use sqrt of the absolute residuals
plot(fitted_values, sqrt(abs(residuals)), 
     xlab = "Fitted Values", 
     ylab = "Sqrt(|Residuals|)", 
     main = "Spread-Level Plot",
     pch = 16, col = "gray")
```

```{r}
behavior_arma2 <- lme(percent_fully_open ~ treatment * genet + mhw,
                   random = ~1|genet_tank,
                   data = behavior_clean,
                   correlation = corARMA(p = 4, q = 2))

behavior_ar <- lme(percent_fully_open ~ treatment * genet + mhw,
                   random = ~1|genet_tank,
                   data = behavior_clean,
                   correlation = corAR1(form = ~ 1 | genet_tank))

behavior_ar2 <- lme(percent_fully_open ~ treatment * genet,
                   random = ~1|tank,
                   data = behavior_clean,
                   correlation = corAR1(form = ~ 1 | tank))
```

```{r}
behavior_arma2 <- lme(percent_fully_open ~ treatment * genet + mhw,
                   random = ~1|genet_tank,
                   data = behavior_clean,
                   correlation = corARMA(p = 4, q = 3))

acf(residuals(behavior_arma), main = "ACF of Residuals")
pacf(residuals(behavior_arma), main = "PACF of Residuals")

acf(residuals(behavior_arma2), main = "ACF of Residuals")
pacf(residuals(behavior_arma2), main = "PACF of Residuals")

```



