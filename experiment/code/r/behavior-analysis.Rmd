---
title: "RMANOVA"
author: "Amelia Ritger"
date: "2024-11-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Create clean df
```{r}
behavior_clean <- all %>%
  mutate(genet_tank = paste(tank, genet, sep = "")) %>%
  dplyr::select(date, tank, genet, genet_tank, treatment, mhw, n_true, percent_fully_open, percent_closed)

```

# Initial plot to visualize trends
```{r}
ggplot(behavior_clean, aes(x = genet, y = percent_fully_open, fill = genet, group = interaction(genet, mhw), shape = mhw)) +
  geom_point(aes(color = genet), position = position_dodge(width = 0.9), alpha = 0.5) +
  geom_violin(aes(size = mhw), position = position_dodge(width = 0.9), alpha = 0.3, color = alpha("black", 0.75)) +
  facet_wrap(~treatment,
             labeller =  labeller(treatment = c("cold" = "Ambient", "severe" = "Severe MHW", "extreme" = "Extreme MHW"))) +
  scale_size_manual(values = c("during" = 1, "after" = 0.5), labels = c("During MHW", "After MHW")) + # Define sizes for mhw levels
  scale_shape_manual(values = c("during" = 16, "after" = 17), labels = c("During MHW", "After MHW")) + # Define shapes for mhw levels
  # change color of violin 
  scale_fill_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  scale_color_manual(values = c("A" = "#9370DB", "B" = "#C21B78", "C" = "#FF9933", "D" ="#FF3333", "E" = "#662B45")) +
  theme_minimal() +
  labs(x = "Genet",
       y = "% open polyps",
       color = "Genet",
       shape = "MHW",
       size = "MHW") +
  guides(fill = "none",
         color = "none")
```

## Check ANOVA assumptions
```{r}
# Fit your ANOVA model
model <- aov(percent_fully_open ~ mhw * treatment * genet, data = behavior_clean)
model2 <- lmer(percent_fully_open ~ mhw * treatment * genet + (1 | genet_tank), data = behavior_clean)
```


```{r}
# Extract residuals
residuals <- residuals(model)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model))
```

```{r}
# Extract residuals
residuals <- residuals(model2)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model2, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model2))
```

```{r}
# Fit a model with a variance structure (e.g., weights = varIdent for heteroscedasticity)
model_with_var <- lme(percent_fully_open ~ mhw * treatment * genet,
                      random = ~ 1 | genet_tank,
                      weights = varIdent(form = ~ 1 | mhw),  # Adjust variance by timeframe
                      data = behavior_clean)

# Extract residuals
residuals <- residuals(model_with_var)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model_with_var, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model_with_var))
```

```{r}
model3 <- lme(percent_fully_open ~ mhw* treatment + genet,
                   random = ~1|genet_tank,
                   data = behavior_clean,
                   correlation = corAR1(form = ~ 1|genet_tank))

# Extract residuals
residuals <- residuals(model3)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model3, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model3))
```

```{r}
model4 <- lme(percent_fully_open ~ mhw* treatment + genet,
                   random = ~mhw|genet_tank,
                   data = behavior_clean,
                   correlation = corAR1(form = ~ 1|genet_tank))

# Extract residuals
residuals <- residuals(model4)

# Q-Q plot
qqnorm(residuals)
qqline(residuals, col = "red")

# Plot residuals vs. fitted values
plot(model4, which = 1)

# Boxplot of residuals to check for outliers
boxplot(residuals ~ fitted(model4))
```

```{r}
model_with_time_order <- lmer(percent_fully_open ~ mhw * treatment * genet + (1 | genet_tank), data = behavior_clean)

# Fit a model with interactions between timeframe and treatment/genotype
model_with_interactions <- lmer(percent_fully_open ~ mhw * treatment * genet + (1 | genet_tank), data = behavior_clean)

# Check residuals
qqnorm(residuals(model_with_interactions))
qqline(residuals(model_with_interactions), col = "red")
```

```{r}
identify_outliers <- function(value) {
  # Ensure 'value' is a numeric vector
  if (!is.numeric(value)) {
    stop("Input value must be numeric.")
  }
  
  # Calculate Q1 (25th percentile), Q3 (75th percentile), and IQR (Interquartile Range)
  Q1 <- quantile(value, 0.25, na.rm = TRUE)
  Q3 <- quantile(value, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  
  # Define the lower and upper bounds for outliers
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR
  
  # Identify outliers
  outliers <- value[value < lower_bound | value > upper_bound]
  
  # Return the outliers
  return(outliers)
}

behavior_sum <- behavior_clean %>%
  group_by(treatment, mhw, genet) %>%
  summarize(n = n(),
            mean = mean(percent_fully_open),
            sd = sd(percent_fully_open),
            outliers = identify_outliers(percent_fully_open))

# identify outliers
behavior_sum %>%
  filter(mean > 0.5) %>%
  arrange(desc(mean))
```

```{r}
```




