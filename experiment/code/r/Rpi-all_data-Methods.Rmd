---
title: "RPi ALL data visualization - For METHODS paper"
author: "Amelia Ritger"
date: "2023-08-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(lubridate)
library(janitor)
```

# Load data and merge all temp files
```{r, message=FALSE, warning=FALSE}
rm(list = ls())
#temp_files <- list.files(here("experiment", "data", "rpi"), pattern=".*csv")
temp_files <- list.files(here("experiment", "code", "python", "methodsPub", "external"), pattern=".*csv")
temp_all <- data.frame()

for (i in 1:length(temp_files)){
  print(temp_files[i])
  temp_data <- read_csv(here("experiment", "code", "python", "methodsPub", "external", temp_files[i])) #each file will be read in, specify which columns you need read in to avoid any error
  temp_all <- rbind(temp_all, temp_data) #for each iteration, bind the new data to the building dataset
}

temp_all <- temp_all %>%
  clean_names() %>%
  select(1:8)
```

# 2015 Blob data simulation
- FOR 2015 Blob data, ONLY KEEP DATA SINCE 03/13 11:00:00 (that's when I fixed the PID loop)
- I did a small PID loop adjustment at 13:00:00 but it shouldn't significantly affect the plot

## Plot tank temps
```{r}
temp_clean <- temp_all %>%
  mutate(timestamp = ymd_hms(timestamp)) %>%
  select(!last_col(offset=1):last_col(), #%>% #remove hot/cold tank temps
         -heater_status) %>%
  pivot_longer(cols=3:5, names_to = "sensor", values_to = "temperature") %>%
  filter(timestamp > ymd_hms("2024-03-13 11:00:00"),
         timestamp < ymd_hms("2024-03-16 18:01:00"))

ggplot(temp_clean, aes(x=timestamp)) +
  geom_line(aes(y=temperature, color=sensor), size=1) +
  geom_line(aes(y=temp_set), color="black")
```

## Plot average tank temp for every 15 sec reading and for every 1 minute 

```{r}
temp_avg <- temp_all %>%
  mutate(timestamp = ymd_hms(timestamp)) %>%
  select(!last_col(offset=1):last_col()) %>%
  pivot_longer(cols=4:6, names_to = "sensor", values_to = "temperature") %>%
  group_by(timestamp, temp_set, heater_status) %>%
  summarise(avg_temp = mean(temperature)) %>%
  ungroup() %>%
  filter(timestamp > ymd_hms("2024-03-13 11:00:00"),
         timestamp < ymd_hms("2024-03-16 18:01:00"))

temp_five <- temp_all %>%
  mutate(timestamp = ymd_hms(timestamp),
         timestamp = floor_date(timestamp, "1 minute")) %>%
  select(!last_col(offset=1):last_col()) %>%
  pivot_longer(cols=4:6, names_to = "sensor", values_to = "temperature") %>%
  group_by(timestamp, temp_set) %>%
  summarise(avg_temp = mean(temperature)) %>%
  ungroup() %>%
  filter(timestamp > ymd_hms("2024-03-13 11:00:00"),
         timestamp < ymd_hms("2024-03-16 18:01:00"))
  
ggplot(temp_five, aes(x=timestamp)) +
  geom_point(aes(y=avg_temp), color="#D55E00", size=1) +
  geom_line(aes(y=temp_set), color="#000000", size=1.5, alpha=0.7) +
  scale_x_datetime(date_labels = "%b %d - %H:%M",
                   breaks = scales::date_breaks("12 hours"),
                   expand=c(0,0),
                   limits = c(min(temp_five$timestamp),
                              max(temp_five$timestamp))) +
  scale_y_continuous(limits = c(14.8, 15.8), breaks = seq(14.9, 15.8, by = 0.3)) +
  labs(y = expression(paste("Temperature (", degree, "C)")),
       x = "Date and time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=14),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18),
        legend.position="top")

#ggsave(here("experiment", "figures", "2015blob.png"), width=12, height=6)
```

## Plot difference between "expected" and "observed"
```{r}
temp_diff <- temp_five %>%
  mutate(diff = round(temp_set - avg_temp, 3))

temp_diff_avg <- mean(temp_diff$diff)
temp_diff_min <- min(temp_diff$diff)
temp_diff_max <- max(temp_diff$diff)
temp_diff_sd <- sd(temp_diff$diff)
temp_diff_range <- temp_diff_max-temp_diff_min


ggplot(temp_diff, aes(x=timestamp)) +
  geom_point(aes(y=diff), color="#000000", size=1) +
  scale_x_datetime(date_labels = "%b %d - %H:%M",
                   breaks = scales::date_breaks("12 hours"),
                   expand=c(0,0),
                   limits = c(min(temp_five$timestamp),
                              max(temp_five$timestamp))) +
  scale_y_continuous(limits = c(-0.15, 0.07), breaks = seq(-0.15, 0.07, by = 0.1)) +
  labs(y = expression(paste("Temperature difference (", degree, "C)")),
       x = "Date and time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=14),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18),
        legend.position="top")

#ggsave(here("experiment", "figures", "blobDiff.png"), width=12, height=6)
```

# Conventional MHW data

## Plot data
```{r}
temp_simple <- temp_all %>%
  mutate(timestamp = ymd_hms(timestamp),
         timestamp = floor_date(timestamp, "1 minute")) %>%
  select(!last_col(offset=1):last_col()) %>%
  pivot_longer(cols=4:6, names_to = "sensor", values_to = "temperature") %>%
  group_by(timestamp, temp_set) %>%
  summarise(avg_temp = mean(temperature)) %>%
  ungroup() %>%
  #remove datapoints between 2024-03-17 16:32:00 and 2024-03-17 16:57:00
  filter(timestamp != ymd_hms("2024-03-17 16:32:00"),
         timestamp > ymd_hms("2024-03-16 23:00:00"), #remove Blob data
         timestamp > ymd_hms("2024-03-17 08:00:00"), #DELETE THIS WHEN DONE
         timestamp < ymd_hms("2024-03-17 16:38:00") |
           timestamp > ymd_hms("2024-03-17 17:02:00")) %>%
  mutate(timestamp_posix = as.POSIXct(timestamp),
         timestamp_posix_plus = timestamp_posix + (25 * 60),
         timestamp = if_else(timestamp < ymd_hms("2024-03-17 17:03:00"), timestamp_posix_plus, timestamp_posix)) %>%
  #remove the last 2 columns
  select(!last_col(offset=1):last_col())

#get average temperature for entire dataset
temp_avg <- mean(temp_simple$avg_temp) #17.9999
temp_sd <- sd(temp_simple$avg_temp) #0.006 

ggplot(temp_simple, aes(x=timestamp)) +
  #geom_line(aes(y=avg_temp, color=heater_status), size=1) +
  geom_point(aes(y=avg_temp), color="#D55E00", size=1) +
  geom_line(aes(y=temp_set), color="#000000", size=1.5, alpha=0.7) +
  scale_x_datetime(date_labels = "%b %d - %H:%M",
                   breaks = scales::date_breaks("3 hours"),
                   expand=c(0,0),
                   limits = c(min(temp_simple$timestamp),
                              max(temp_simple$timestamp))) +
  #scale_y_continuous(limits = c(14.8, 15.8), breaks = seq(14.9, 15.8, by = 0.3)) +
  labs(y = expression(paste("Temperature (", degree, "C)")),
       x = "Date and time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=14),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18),
        legend.position="top")

#ggsave(here("experiment", "figures", "simple.png"), width=12, height=6)
```

## Plot difference between "expected" and "observed"
```{r}
temp_diff_simple <- temp_simple %>%
  mutate(diff = round(temp_set - avg_temp, 3))

ggplot(temp_diff_simple, aes(x=timestamp)) +
  geom_point(aes(y=diff), color="#000000", size=1) +
  scale_x_datetime(date_labels = "%b %d - %H:%M",
                   breaks = scales::date_breaks("6 hours"),
                   expand=c(0,0),
                   limits = c(min(temp_diff_simple$timestamp),
                              max(temp_diff_simple$timestamp))) +
  scale_y_continuous(limits = c(-0.05, 0.05), breaks = seq(-0.05, 0.05, by = 0.02)) +
  labs(y = expression(paste("Temperature difference (", degree, "C)")),
       x = "Date and time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, vjust = 1, hjust=1, size=14),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18),
        legend.position="top")

#ggsave(here("experiment", "figures", "simpleDiff.png"), width=12, height=6)
```


